name: Cloudflare

on:
  push:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      CLOUDFLARE_API_SECRET: ${{ secrets.CLOUDFLARE_API_SECRET }}
      CLOUDFLARE_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
      CLOUDFLARE_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: "latest"

      - name: Checkout
        uses: actions/checkout@master

      - name: Cache Bun dependencies
        uses: actions/cache@v2
        with:
          path: |
            ~/.bun
            **/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun i

      - name: Build
        run: bun run build
        env:
          NITRO_PRESET: cloudflare
          NODE_OPTIONS: ${{ env.NODE_OPTIONS }}

      - name: Run Tests
        run: bun run test

      - name: Publish to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          # TODO: chnage name to CLOUDFLARE_xxx
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
